<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="My blog">
        <meta name="viewport" content="width=device-width">
        <title>一段代码演变的故事 &mdash; 愚钝的故事</title>
            <link rel="stylesheet" href="../../../static/normalize.css" type="text/css">
            <link rel="stylesheet" href="../../../static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="../../../static/main.css" type="text/css">
            <link rel="stylesheet" href="../../../static/modern5.css" type="text/css">
            <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="../../../static/webfont.css" type="text/css">
        <link rel="shortcut icon" href="../../../static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="../../../static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../../../static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="../../../static/plugins.js"></script>
        <script src="../../../static/main.js"></script>
        <link rel="next" title="如何查看进程打开的文件" href="../../02/16/lsfiles.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../static/underscore.js"></script><script type="text/javascript" src="../../../static/doctools.js"></script><script type="text/javascript" src="../../../static/disqus.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Adjusts document height if sidebar is taller
            var documentwrapper = document.getElementsByTagName("article")[0];
            var sidebar = document.getElementsByClassName("sidebar")[0];

            if (sidebar.offsetHeight > documentwrapper.offsetHeight)
            {
                var mainwrapper = document.getElementsByClassName("main")[0];
                documentwrapper.style.minHeight = mainwrapper.offsetHeight + "px";
            }

            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(document.getElementsByTagName("article")[0].offsetTop - 44);
            }
        });
    </script></head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header>
            <hgroup>
              <h1><a href="../../../index.html">愚钝的故事</a></h1><h2>记录我和Java，Groovy,Python的点点滴滴</h2></hgroup>
          </header>
      <nav>
            <ul><li class="quicklink"><div class="rss">
        <a href="../../../rss.html" title="Subscribe via RSS"><span class="webfont">B</span></a>
    </div></li><li class="main-nav">
                  <a href="../../../index.html">Home</a>
                </li>
              </ul>
          </nav><div class="main-container"><div class="main wrapper clearfix"><article><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="../../02/16/lsfiles.html">如何查看进程打开的文件</a> &raquo; </li>
        </ul><div class="timestamp postmeta">
            <span>八月 23, 2013</span>
        </div>
    <div class="section" id="id1">
<h1>一段代码演变的故事</h1>
<dl class="docutils">
<dt>前段时间项目需要从一个mysql数据库(记做A库)导入到另外mysql数据库（记做B库)。在到换的过程中需要对数据进行一些转换。本质而言就是把同样的业务数据分成不同的格式进行存储。初期的我们想法很简单，通过如下步骤来完成：</dt>
<dd><ol class="first last arabic simple">
<li>从老库逐条读取出数据，</li>
<li>将这些数据拼装成POJO，这些POJO通过ORM框架可以直接存入数据库B</li>
<li>通过ORM框架将数据逐条出入数据库。</li>
</ol>
</dd>
</dl>
<p>主题的程序结构如下为代码所示:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DBMigrate</span><span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">//分析参数</span>
      <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
          <span class="n">id</span> <span class="o">=</span> <span class="n">startId</span> <span class="o">+</span> <span class="n">i</span>
          <span class="n">pojo</span> <span class="o">=</span> <span class="n">loadOldPOJO</span><span class="o">(</span><span class="n">id</span><span class="o">);</span> <span class="c1">//从老库获取POJO</span>
          <span class="n">savePOJO2NewDB</span><span class="o">(</span><span class="n">pojo</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="nf">loadOldPOJO</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">){</span>
      <span class="n">POJO</span> <span class="n">pojo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">POJO</span><span class="o">();</span>
      <span class="n">String</span> <span class="n">sql1</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
      <span class="n">getRS</span><span class="o">(</span><span class="n">sql1</span><span class="o">)</span> <span class="c1">//根据一个Sql查询POJO中的一部分。拼装入pojo</span>
      <span class="o">............</span>
      <span class="o">............</span> <span class="c1">//根据不同的sql，重复上面的步骤。</span>

      <span class="k">return</span> <span class="n">pojo</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">savePOJO2NewDB</span><span class="o">(</span><span class="n">POJO</span> <span class="n">pojo</span><span class="o">){</span>
      <span class="c1">//使用ibatis保存该记录。</span>
      <span class="c1">//同时会更新n多表</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>牛x的你可能一眼就能看出我们这个结构中致命的问题&#8211;效率！ 逐条导入数据效率会非常底下。一笔数据将要多次连接数据库。另外当前结构还有一个致命缺点就是啥和啥的都混在一起。想要加个表和减少一个表都很困难。</p>
<p>针对上面的问题我们不得不对这段代码做点改动。改动的第一目标就是让他快起来！</p>
<div class="section" id="id2">
<h2>加速</h2>
<p>加速时目标。手段是减少和数据库交互。说白了就是批量处理这个的感谢mysql提供了强大的插入命令。</p>
<div class="highlight-mysql"><pre>INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE]
[INTO] tbl_name
[PARTITION (partition_name,...)]
[(col_name,...)]
{VALUES | VALUE} ({expr | DEFAULT},...),(...),...
[ ON DUPLICATE KEY UPDATE
col_name=expr
[, col_name=expr] ... ]</pre>
</div>
<p>这个命令可以一次插入很多条数据，只要你的sql够长就可以。就像下面的样子：</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tbl_name</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="k">c</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">),(</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span>
</pre></div>
</div>
<p>这样就往数据库中插入了三条记录。1000条也是这样。这个就是我们的核心技术。
为了能够对数据库表批量操作。将不再将老数据拼装中间状态的POJO，直接使用对应于新表的POJO。** 让数据从业务逻辑中解放出来**
所以就有一些和与B数据库表一一对应的POJO。下面的转换的过程就以这个与B数据库一一对应的表为中心。下面要做的事情就时很老套的了。</p>
<blockquote>
<div><ol class="arabic simple">
<li>根据POJO从A数据库中获取一批该数据库所需要的。</li>
<li>拼装成和B数据库表对应的POJO</li>
<li>使用批量插入语句将POJO插入到新的数据库。</li>
</ol>
<dl class="docutils">
<dt>在上述动作中对每一个表操作的不同点有三点：</dt>
<dd><ol class="first last arabic simple">
<li>从A数据库获取数据的sql</li>
<li>将从A数据库获取的数据拼装成对象。</li>
<li>POJO插入到B数据库时，对应的字段。也就是插入方式不同。</li>
</ol>
</dd>
</dl>
</div></blockquote>
<p>只要将上述这个三个地方抽取出来我们就可以用一套代码完成所有表的操作。基于这个思路我们有了如下的代码.</p>
<p>在上图的结构中IRecordCallBack 中的 getQuerySql 方法用于解决如何获取数据的问题。processRecord 方法用于解决如何拼装POJO的问题。
BatchOperate 方法中用于解决如何保存的问题。
这样所有问题都解决了。我们的工作是否完了呢。还没有，还缺少一个总管来协调让这些分散的类协同工作。</p>
</div>
<div class="section" id="id3">
<h2>程序的拼装</h2>
<p>在前期的程序中，我们直接将程序里面。这样如果要加一个表，牵涉的内容会比较多。
我们做了如下改进。同样时以于与数据库B一一对应的POJO为中心创建两个Map，具体代码如下：</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">IRecordCallBack</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">IRecordCallBack</span><span class="o">&lt;?&gt;&gt;();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]&gt;</span> <span class="n">daoMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]&gt;();</span>
<span class="kd">static</span> <span class="o">{</span>
    <span class="n">callbacks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">SomePOJO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">SomePOJORecordCallBack</span><span class="o">())</span>
    <span class="n">callbacks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AnotherPOJODao</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">AnotherPOJORecordCallBack</span><span class="o">())</span>
    <span class="n">daoMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">SomePOJO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">SomePOJODao</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="n">daoMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">AnotherPOJO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">AnotherPOJODao</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>

<span class="o">}</span>
</pre></div>
</div>
<p>有了这样的配置信息后，我们后期的程序根本不许要知道当前处理的时什么pojo。只是知道取数据，交给dao取保存就可以了。下面给出伪代码如下：</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startMigrate</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">){</span>
    <span class="c1">//获取数据库连接</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">IRecordCallBack</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">tableItem</span> <span class="o">:</span> <span class="n">callbacks</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">tableItem</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">getQuerySql</span><span class="o">());</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tableItem</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">processRecord</span><span class="o">(</span><span class="n">rs</span><span class="o">));</span>
                <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span> <span class="o">:</span> <span class="n">daoMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tableItem</span><span class="o">.</span><span class="na">getKey</span><span class="o">())){</span>
            <span class="n">BatchOperate</span> <span class="n">dao</span> <span class="o">=</span> <span class="o">(</span><span class="n">BatchOperate</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="n">cls</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;cls.getName():&quot;</span><span class="o">+</span><span class="n">cls</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">dao</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()!=</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">dao</span><span class="o">.</span><span class="na">saveByBatch</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
        <span class="c1">//各种善后</span>
        <span class="c1">//小睡一会</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这个就是所有改善后的结果。这样改动后效率提升了不少。结构上也把重复的代码去掉。今后如果要加入新的数据库表的话，只需要实现一个POJO, IRecordCallBack 和Dao就可以了。其他东西都不用动了。</p>
</div>
<div class="section" id="id4">
<h2>扩展,插件化</h2>
<p>到这里应该说告一段落了。但是还没有完。现在的情况如果你要添加一个表的导入的话。你还的修改daoMap和callBacks这两个map。</p>
<p>其实我们这边很容易通过 <a class="reference external" href="http://en.wikipedia.org/wiki/Service_provider_interface">SPI</a>  将IRecordCallBack 和BatchOperate 服务化。通过 java.util.ServiceLoader 来动态获取当前系统中已经存在的实现。动态创建daoMap和callbacks，这样就建立起了一个可管理插件的框。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">某个牛人说过：写软件就是在别人写的框子里填数，或则自己写框让别人填数。</p>
</div>
<p>我们只是做好了让别人(包括我们自己)填的框！</p>
</div>
</div>

    <div class="postmeta">
        <div class="author">
            <span>Posted by Jet Geng</span>
        </div>
        
        
        </div>
    <div id="disqus_thread"></div><script type="text/javascript">    var disqus_shortname = "techfoolishstory";    var disqus_identifier = "2013/08/23/scodestory";    disqus_thread();</script><noscript>Please enable JavaScript to view the    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="../../02/16/lsfiles.html">如何查看进程打开的文件</a> &raquo; </li>
        </ul></article><aside class="sidebar"><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="#">一段代码演变的故事</a>
        </li><li>
            <a href="../../02/16/lsfiles.html">如何查看进程打开的文件</a>
        </li><li>
            <a href="../../02/16/soapui_mock.html">用SoapUI mock Web服务</a>
        </li><li>
            <a href="../../../2012/12/11/webinosgi.html">在OSGi中部署Web应用(一)</a>
        </li><li>
            <a href="../../../2012/08/21/pyaudio.html">Kid Capture开发手记</a>
        </li><li>
            <a href="../../../2012/07/02/jbossover.html">使用Maven和tycho构建OSGi插件项目</a>
        </li></ul>
</div>
</section><section><div class="widget" id="searchbox">
    <h1>Search</h1>
    <form action="../../../search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="webfont">L</span></button>
    </form>
</div></section></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container"><footer class="wrapper">&copy; Copyright 2012, Jet Geng. Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>